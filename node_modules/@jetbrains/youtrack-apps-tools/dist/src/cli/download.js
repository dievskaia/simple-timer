"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.download = download;
const tslib_1 = require("tslib");
const fs_1 = tslib_1.__importDefault(require("fs"));
const promises_1 = require("node:fs/promises");
const node_stream_1 = require("node:stream");
const path_1 = tslib_1.__importDefault(require("path"));
const zl = tslib_1.__importStar(require("zip-lib"));
const exit_1 = require("../../lib/cli/exit");
const tmpdir_1 = require("../../lib/fs/tmpdir");
const i18n_1 = require("../../lib/i18n/i18n");
const request_1 = require("../../lib/net/request");
const resolve_1 = require("../../lib/net/resolve");
async function download(config, appName) {
    if (!appName) {
        (0, exit_1.exit)(new Error((0, i18n_1.i18n)('App name should be defined')));
        return;
    }
    appName = appName.toString();
    const url = (0, resolve_1.resolve)(config.host, `/api/admin/apps/${appName.replace(/^@/, '')}`);
    const options = {
        headers: {
            Accept: 'application/zip',
            'Content-Type': 'application/json',
        },
    };
    const requestParams = (0, request_1.generateRequestParams)(config, url.href, options);
    try {
        const res = await fetch(requestParams);
        if (!res.ok || !res.body) {
            const errorMessage = await (0, request_1.prepareErrorMessage)(res);
            throw new Error(errorMessage);
        }
        const body = node_stream_1.Readable.fromWeb(res.body);
        await processResponseBody(body, appName);
    }
    catch (error) {
        (0, exit_1.exit)(error);
    }
    function getZipName(appName) {
        return 'youtrack-app-' + appName.split('/').pop() + '.zip';
    }
    async function processResponseBody(body, appName) {
        const tempZipPath = (0, tmpdir_1.tmpDir)(getZipName(appName));
        await (0, promises_1.writeFile)(tempZipPath, body);
        const output = config.output || config.cwd;
        const shouldOverwrite = config.overwrite !== null;
        if (shouldOverwrite) {
            const existingPath = path_1.default.resolve(output, appName);
            fs_1.default.rmSync(existingPath, { recursive: true, force: true });
        }
        await zl.extract(tempZipPath, path_1.default.resolve(output, appName));
        if (!shouldOverwrite) {
            console.log((0, i18n_1.i18n)(`File extracted into '${output}'`));
        }
        else {
            console.log((0, i18n_1.i18n)(`File extracted into '${output}' and existing files are overwritten`));
        }
    }
}
