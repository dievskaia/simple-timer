"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.upload = upload;
const tslib_1 = require("tslib");
const promises_1 = require("node:fs/promises");
const node_path_1 = tslib_1.__importDefault(require("node:path"));
const zl = tslib_1.__importStar(require("zip-lib"));
const exit_1 = require("../../lib/cli/exit");
const tmpdir_1 = require("../../lib/fs/tmpdir");
const i18n_1 = require("../../lib/i18n/i18n");
const request_1 = require("../../lib/net/request");
const resolve_1 = require("../../lib/net/resolve");
const upload_utils_1 = require("./upload-utils");
async function upload(config, appDir) {
    const appName = (0, upload_utils_1.resolveAppName)(appDir);
    if (!appName || !appDir) {
        (0, exit_1.exit)(new Error((0, i18n_1.i18n)('Unexpected error')));
        return;
    }
    const zipPath = (0, tmpdir_1.tmpDir)(generateZipName(appDir));
    try {
        await zl.archiveFolder(node_path_1.default.resolve(config.cwd, appDir), zipPath);
        await updateApp();
    }
    catch (error) {
        (0, exit_1.exit)(error);
    }
    async function updateApp(isCreate = false) {
        const body = new FormData();
        const blob = new Blob([await (0, promises_1.readFile)(zipPath)]);
        body.set('file', blob, `${appName}.zip`);
        const url = (0, resolve_1.resolve)(config.host, '/api/admin/apps/import');
        const options = {
            method: 'POST',
            body,
        };
        const requestParams = (0, request_1.generateRequestParams)(config, url.href, options);
        try {
            const res = await fetch(requestParams);
            if (!res.ok) {
                const error = await (0, request_1.prepareErrorMessage)(res);
                throw new Error(error);
            }
            const { id } = (await res.json());
            const appLink = `${config.host}/admin/apps?selected=${id}&tab=settings`;
            if (isCreate) {
                console.log((0, i18n_1.i18n)('App "' + appName + '" created'));
            }
            else {
                console.log((0, i18n_1.i18n)('App "' + appName + '" uploaded'));
            }
            if (config.open) {
                const { default: openInBrowser } = await import('open');
                await openInBrowser(appLink);
            }
            else {
                console.log((0, i18n_1.i18n)(`To configure the app please proceed to: ${appLink}`));
            }
        }
        catch (error) {
            if (isErrorWithStatusCodeAndData(error) && error.statusCode === 404 && !isCreate) {
                return updateApp(true);
            }
            else {
                (0, exit_1.exit)(error);
            }
        }
    }
    function generateZipName(appDir) {
        return 'youtrack-app-' + node_path_1.default.basename(appDir) + '.zip';
    }
    function isErrorWithStatusCodeAndData(error) {
        return error instanceof Error && ('statusCode' in error || 'data' in error);
    }
}
